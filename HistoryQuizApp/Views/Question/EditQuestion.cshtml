@{
    ViewBag.Title = "Chỉnh sửa Câu hỏi";
    Layout = "_LayoutAdmin";
}
@model HistoryQuizApp.Models.EF.Question
<div class="container-xxl flex-grow-1 container-p-y">
    <div class="row">
        <div class="col-md-5">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Chỉnh sửa câu hỏi</h5>
                    <small class="text-muted float-end"></small>
                </div>
                <div class="card-body">
                    <form>
                        <div class="mb-3">
                            <label class="form-label" for="content">Câu hỏi</label>
                            <input type="text" class="form-control" id="content" placeholder="Abc" value="@Model.Content">
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="description">Mô tả</label>
                            <textarea rows="4" class="form-control" id="description" placeholder="...">@Model.Description</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="slectGrade">Phân loại</label>
                            <select id="slectGrade" class="form-select">
                                <option value="5" selected="@(Model.GradeId == 5 ? "selected" : "")">Lớp 4</option>
                                <option value="6" selected="@(Model.GradeId == 6 ? "selected" : "")">Lớp 5</option>
                                <option value="7" selected="@(Model.GradeId == 7 ? "selected" : "")">Lớp 6</option>
                                <option value="8" selected="@(Model.GradeId == 8 ? "selected" : "")">Lớp 7</option>
                                <option value="9" selected="@(Model.GradeId == 9 ? "selected" : "")">Lớp 8</option>
                                <option value="10" selected="@(Model.GradeId == 10 ? "selected" : "")">Lớp 9</option>
                                <option value="1" selected="@(Model.GradeId == 1 ? "selected" : "")">Lớp 10</option>
                                <option value="2" selected="@(Model.GradeId == 2 ? "selected" : "")">Lớp 11</option>
                                <option value="3" selected="@(Model.GradeId == 3 ? "selected" : "")">Lớp 12</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="slectChapter">Chương</label>
                            <select id="slectChapter" class="form-select">
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="slectCategory">Thể loại</label>
                            <select id="slectCategory" class="form-select">
                                @foreach (var item in ViewBag.ListCategory)
                                {
                                    <option value="@item.Id" selected="@(Model.CategoryId == item.Id ? "selected" : "")">@item.CategoryName</option>
                                }
                            </select>
                        </div>
                        <button type="submit" id="btnAddQuestion" class="btn btn-primary">Cập nhật câu hỏi</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Cập nhật đáp án</h5>
                    <small class="text-muted float-end"></small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-10">
                            <form>
                                <div class="mb-3 row">
                                    <div class="col-md-3">
                                        <label class="form-label" for="defaultRadio1">Đáp án đúng</label>
                                        <div class="form-check d-flex justify-content-center mt-3">
                                            <input name="default-radio" class="form-check-input" type="radio" value="1" id="defaultRadio1" @(Model.Answers.ElementAtOrDefault(0)?.IsCorrect == true ? "checked" : "")>
                                        </div>
                                    </div>
                                    <div class="col-md-9">
                                        <label class="form-label" for="answer1">Đáp án 1</label>
                                        <textarea id="answer1" class="form-control" placeholder="A...">@Model.Answers.ElementAtOrDefault(0)?.Content</textarea>
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <div class="col-md-3 mt-5">
                                        <div class="form-check d-flex justify-content-center">
                                            <input name="default-radio" class="form-check-input" type="radio" value="2" id="defaultRadio2" @(Model.Answers.ElementAtOrDefault(1)?.IsCorrect == true ? "checked" : "")>
                                        </div>
                                    </div>
                                    <div class="col-md-9">
                                        <label class="form-label" for="answer2">Đáp án 2</label>
                                        <textarea id="answer2" class="form-control" placeholder="B...">@Model.Answers.ElementAtOrDefault(1)?.Content</textarea>
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <div class="col-md-3 mt-5">
                                        <div class="form-check d-flex justify-content-center">
                                            <input name="default-radio" class="form-check-input" type="radio" value="3" id="defaultRadio3" @(Model.Answers.ElementAtOrDefault(2)?.IsCorrect == true ? "checked" : "")>
                                        </div>
                                    </div>
                                    <div class="col-md-9">
                                        <label class="form-label" for="answer3">Đáp án 3</label>
                                        <textarea id="answer3" class="form-control" placeholder="C...">@Model.Answers.ElementAtOrDefault(2)?.Content</textarea>
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <div class="col-md-3 mt-5">
                                        <div class="form-check d-flex justify-content-center">
                                            <input name="default-radio" class="form-check-input" type="radio" value="4" id="defaultRadio4" @(Model.Answers.ElementAtOrDefault(3)?.IsCorrect == true ? "checked" : "")>
                                        </div>
                                    </div>
                                    <div class="col-md-9">
                                        <label class="form-label" for="answer4">Đáp án 4</label>
                                        <textarea id="answer4" class="form-control" placeholder="D...">@Model.Answers.ElementAtOrDefault(3)?.Content</textarea>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var gradeId = @Model.GradeId; 

    document.querySelectorAll('#slectGrade option').forEach(function (option) {
        if (option.value == gradeId) {
            option.selected = true;
        } else {
            option.selected = false;
        }
    });
    getListChapter(gradeId);
    $('#slectGrade').change(function () {
        const selectedGrade = $(this).val();
        getListChapter(selectedGrade);
    });

    function getListChapter(value) {
        $.ajax({
            type: "POST",
            url: '@Url.Action("GetListChapterByGrade", "Question", new { area = "" })',
            data: {
                idgrade: value
            },
            success: function (response) {
                if (response.status == true) {
                    let options = "";
                    response.data.forEach(chapter => {
                        options += `<option value="${chapter.id}" ${chapter.id == @Model.ChapterId ? "selected" : ""}>${chapter.chapterName}</option>`;
                    });
                    $('#slectChapter').html(options);
                }
                else {
                    Swal.fire({
                        title: "Thông báo",
                        text: "Đã xảy ra lỗi!",
                        icon: "question"
                    });
                }
            },
            error: function (err) {
                Swal.fire({
                    title: "Lỗi",
                    text: "Không thể tải dữ liệu chương.",
                    icon: "error"
                });
            }
        })
    }

    $('#btnAddQuestion').click(function (e) {
        e.preventDefault();

        // Thu thập dữ liệu câu hỏi
        const question = {
            Id: @Model.Id,
            Content: $('#content').val(),
            GradeId: $('#slectGrade').val(),
            ChapterId: $('#slectChapter').val(),
            CategoryId: $('#slectCategory').val(),
            Description: $('#description').val(),
            Choices: []
        };

        // Thu thập danh sách đáp án
        for (let i = 1; i <= 4; i++) {
            const answerContent = $(`#answer${i}`).val();
            const isCorrect = $(`#defaultRadio${i}`).is(':checked');
            if (answerContent) {
                question.Choices.push({
                    Content: answerContent,
                    IsCorrect: isCorrect
                });
            }
        }

        // Kiểm tra dữ liệu
        if (!question.Content || !question.Description || question.Choices.length === 0) {
            Swal.fire({
                title: "Thông báo",
                text: "Vui lòng điền đầy đủ thông tin!",
                icon: "warning"
            });
            return;
        }

        // Gửi AJAX
        $.ajax({
            type: "POST",
            url: '@Url.Action("UpdateQuestion", "Question", new { area = "" })',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(question),
            success: function (response) {
                if (response.status) {
                    location.reload();
                } else {
                    Swal.fire({
                        title: "Lỗi",
                        text: response.msg,
                        icon: "error"
                    });
                }
            },
            error: function (err) {
                Swal.fire({
                    title: "Lỗi",
                    text: "Có lỗi xảy ra khi chỉnh sửa câu hỏi.",
                    icon: "error"
                });
            }
        });
    });
</script>
